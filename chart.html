<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Budget Chart</title>
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <header>
      <h1>Personal Budget Chart</h1>
    </header>
    <main>
      <div>
        <h2>Pie Chart</h2>
        <canvas id="myChart" width="400" height="400"></canvas>
      </div>
      <div id="pie-chart"></div>
    </main>
    <footer>
      <p>Created by Saisuraj Jindam</p>
    </footer>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
      // Chart.js setup
      var dataSource = {
        datasets: [
          {
            data: [],
            backgroundColor: [
              "#ffcd56",
              "#ff6384",
              "#36a2eb",
              "#fd6b19",
              "#83FF33",
              "#F633FF",
              "#FF3333",
            ],
          },
        ],
        labels: [],
      };

      // D3 setup
      var svg = d3.select("#pie-chart").append("svg").append("g");
      svg.append("g").attr("class", "slices");
      svg.append("g").attr("class", "labels");
      svg.append("g").attr("class", "lines");

      var width = 650,
        height = 300,
        radius = Math.min(width, height) / 2;

      var pie = d3.layout
        .pie()
        .sort(null)
        .value(function (d) {
          return d.budget;
        });

      var arc = d3.svg
        .arc()
        .outerRadius(radius * 0.8)
        .innerRadius(radius * 0.4);

      var outerArc = d3.svg
        .arc()
        .innerRadius(radius * 0.9)
        .outerRadius(radius * 0.9);

      svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      var color = d3.scale
        .ordinal()
        .range([
          "#ffcd56",
          "#ff6384",
          "#36a2eb",
          "#fd6b19",
          "#83FF33",
          "#F633FF",
          "#FF3333",
        ]);

      function createChart() {
        var ctx = document.getElementById("myChart").getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: dataSource,
        });
      }

      function change(data) {
        var slice = svg
          .select(".slices")
          .selectAll("path.slice")
          .data(pie(data), function (d) {
            return d.data.title;
          });

        slice
          .enter()
          .insert("path")
          .style("fill", function (d) {
            return color(d.data.title);
          })
          .attr("class", "slice");

        slice
          .transition()
          .duration(1000)
          .attrTween("d", function (d) {
            this._current = this._current || d;
            var interpolate = d3.interpolate(this._current, d);
            this._current = interpolate(0);
            return function (t) {
              return arc(interpolate(t));
            };
          });

        slice.exit().remove();
      }

      function getBudget() {
        axios.get("http://localhost:3000/budget").then(function (res) {
          var newData = res.data.myBudget.map((item) => ({
            title: item.title,
            budget: item.budget,
          }));

          dataSource.datasets[0].data = newData.map((d) => d.budget);
          dataSource.labels = newData.map((d) => d.title);

          createChart();
          change(newData);
        });
      }

      getBudget();
    </script>
  </body>
</html>
